sap.ui.define(                                                                                                                                                                                                                                                 
  [                                                                                                                                                                                                                                                            
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "../model/formatter",                                                                                                                                                                                                                                      
  ],                                                                                                                                                                                                                                                           
  function (Controller, JSONModel, formatter) {                                                                                                                                                                                                                
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend(                                                                                                                                                                                                                                  
      "br.com.lit.zui5.ne.logistics.offline.controller.ReportDeposit",                                                                                                                                                                                         
      {                                                                                                                                                                                                                                                        
        formatter: formatter,                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        onInit: function () {                                                                                                                                                                                                                                  
          var oReportDeposit = new JSONModel();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
          // Atribuindo Rotas à metodos específicos                                                                                                                                                                                                            
          const oRouter = this.getOwnerComponent().getRouter();                                                                                                                                                                                                
          oRouter.getRoute("RouteReportDeposit").attachPatternMatched(this.onBeforeShow, this);                                                                                                                                                                
                                                                                                                                                                                                                                                               
          var oPage = new JSONModel({                                                                                                                                                                                                                          
            page: 0,                                                                                                                                                                                                                                           
            previousPageAvailable: false,                                                                                                                                                                                                                      
            nextPageAvailable: false,                                                                                                                                                                                                                          
          });                                                                                                                                                                                                                                                  
          this.getView().setModel(oPage, "DepositPage");                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          this.getView().setModel(oReportDeposit, "ReportDeposit");                                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // Toda vez que a rota é aberta, os dados são recarregados                                                                                                                                                                                             
        onBeforeShow: function () {                                                                                                                                                                                                                            
          // Voltando para a primeira página ao reabrir a tela                                                                                                                                                                                                 
          let pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          pageModel.setProperty("/page", 0);                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          this.onBtnClearPress()                                                                                                                                                                                                                               
          this.getData();                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // Insira um valor adicional para fazer buscas em páginas a frente da atual                                                                                                                                                                            
        // Ex.: a função verifyNextPage() utiliza para verificar se há valores na próxima página                                                                                                                                                               
        buildUrlToGetData: function (additionalPage = 0) {                                                                                                                                                                                                     
          var pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          let page = pageModel.getProperty("/page") + additionalPage;                                                                                                                                                                                          
          let lgnum = this.getView().byId("searchFieldLgnumDeposit").getValue();                                                                                                                                                                               
          let werks = this.getView().byId("searchFieldWerksDeposit").getValue();                                                                                                                                                                               
          let lgort = this.getView().byId("searchFieldLgortDeposit").getValue();                                                                                                                                                                               
          let url = `http://localhost:8080/v1/lgnum?page=${page}`;                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          // Filtrando Número de Depósito                                                                                                                                                                                                                      
          if (lgnum) url += `&lgnum=${lgnum}`;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
          // Filtrando Centro                                                                                                                                                                                                                                  
          if (werks) url += `&werks=${werks}`;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
          // Filtrando Depósito                                                                                                                                                                                                                                
          if (lgort) url += `&lgort=${lgort}`;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
          return url;                                                                                                                                                                                                                                          
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        getData: function () {                                                                                                                                                                                                                                 
          let dataModel = this.getView().getModel("ReportDeposit");                                                                                                                                                                                            
          let url = this.buildUrlToGetData();                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (response) {                                                                                                                                                                                                                     
              response.forEach((item) => {                                                                                                                                                                                                                     
                // Divide em data e hora                                                                                                                                                                                                                       
                const [datePart, timePart] = item.crdate.split("T");                                                                                                                                                                                           
                // Divide a data no formato "YYYY-MM-DD"                                                                                                                                                                                                       
                const [year, month, day] = datePart.split("-");                                                                                                                                                                                                
                // Formata para "DD-MM-YYYY"                                                                                                                                                                                                                   
                item.crdate = `${day}/${month}/${year}`;                                                                                                                                                                                                       
                // Mantém a hora no formato original                                                                                                                                                                                                           
                item.crtime = timePart ? timePart.split(".")[0] : "";                                                                                                                                                                                          
              });                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              let _data = response;                                                                                                                                                                                                                            
              dataModel.setData(_data);                                                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            error: function (error) {                                                                                                                                                                                                                          
              console.log(error);                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          this.verifyPreviousPage();                                                                                                                                                                                                                           
          this.verifyNextPage();                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        verifyPreviousPage: function () {                                                                                                                                                                                                                      
          let pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          let page = pageModel.getProperty("/page");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/previousPageAvailable", page > 0 ? true : false);                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        verifyNextPage: function () {                                                                                                                                                                                                                          
          let pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          let url = this.buildUrlToGetData(1);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              pageModel.setProperty("/nextPageAvailable", data.length > 0 ? true : false);                                                                                                                                                                     
            },                                                                                                                                                                                                                                                 
            error: function () {                                                                                                                                                                                                                               
              pageModel.setproperty("/nextpageavailable", false);                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onPreviousPageBtnPress: function () {                                                                                                                                                                                                                  
          let pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          let page = pageModel.getProperty("/page") - 1;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/page", page);                                                                                                                                                                                                                
          this.getData();                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onNextPageBtnPress: function () {                                                                                                                                                                                                                      
          let pageModel = this.getView().getModel("DepositPage");                                                                                                                                                                                              
          let page = pageModel.getProperty("/page") + 1;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/page", page);                                                                                                                                                                                                                
          this.getData();                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        //----------DIALOG NÚMERO DE DEPÓSITO----------                                                                                                                                                                                                        
        onValueHelpLgnum: function () {                                                                                                                                                                                                                        
          let oValueHelpLgnum = new JSONModel();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          this.getView().setModel(oValueHelpLgnum, "ValueHelpLgnum");                                                                                                                                                                                          
          this.byId("valueHelpDialogLgnumDeposit").open();                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("ValueHelpLgnum");                                                                                                                                                                                           
          let url = "http://localhost:8080/v1/lgnum?sort=lgnum";                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              let dataFiltered = Array.from(                                                                                                                                                                                                                   
                data.reduce((map, item) => map.set(item.lgnum, item), new Map()).values()                                                                                                                                                                      
              );                                                                                                                                                                                                                                               
              dataModel.setData(dataFiltered);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onCloseDialogLgnum: function () {                                                                                                                                                                                                                      
          this.byId("valueHelpDialogLgnumDeposit").close();                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogLgnum: function (oEvent) {                                                                                                                                                                                                               
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("tableDialogLgnumDeposit");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "lgnum",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionChangeDialogLgnum: function (oEvent) {                                                                                                                                                                                                      
          this.oLgnum = oEvent                                                                                                                                                                                                                                 
            .getParameter("listItem")                                                                                                                                                                                                                          
            .getBindingContext("ValueHelpLgnum")                                                                                                                                                                                                               
            .getProperty("lgnum");                                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionConfirmDialogLgnum: function () {                                                                                                                                                                                                           
          this.byId("searchFieldLgnumDeposit").setValue(this.oLgnum);                                                                                                                                                                                          
          this.byId("valueHelpDialogLgnumDeposit").close();                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        //----------DIALOG CENTRO----------                                                                                                                                                                                                                    
        onValueHelpWerks: function () {                                                                                                                                                                                                                        
          let oValueHelpWerks = new JSONModel();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          this.getView().setModel(oValueHelpWerks, "ValueHelpWerks");                                                                                                                                                                                          
          this.byId("valueHelpDialogWerksDeposit").open();                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("ValueHelpWerks");                                                                                                                                                                                           
          let url = "http://localhost:8080/v1/lgnum?sort=werks";                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              let dataFiltered = Array.from(                                                                                                                                                                                                                   
                data.reduce((map, item) => map.set(item.werks, item), new Map()).values()                                                                                                                                                                      
              );                                                                                                                                                                                                                                               
              dataModel.setData(dataFiltered);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogWerks: function (oEvent) {                                                                                                                                                                                                               
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("tableDialogWerksDeposit");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "werks",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionChangeDialogWerks: function (oEvent) {                                                                                                                                                                                                      
          this.oWerks = oEvent                                                                                                                                                                                                                                 
            .getParameter("listItem")                                                                                                                                                                                                                          
            .getBindingContext("ValueHelpWerks")                                                                                                                                                                                                               
            .getProperty("werks");                                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionConfirmDialogWerks: function () {                                                                                                                                                                                                           
          this.byId("searchFieldWerksDeposit").setValue(this.oWerks);                                                                                                                                                                                          
          this.byId("valueHelpDialogWerksDeposit").close();                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        //----------DIALOG DEPÓSITO----------                                                                                                                                                                                                                  
        onValueHelpLgort: function () {                                                                                                                                                                                                                        
          let oValueHelpLgort = new JSONModel();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          this.getView().setModel(oValueHelpLgort, "ValueHelpLgort");                                                                                                                                                                                          
          this.byId("valueHelpDialogLgortDeposit").open();                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("ValueHelpLgort");                                                                                                                                                                                           
          let url = "http://localhost:8080/v1/lgnum?sort=Lgort";                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              let dataFiltered = Array.from(                                                                                                                                                                                                                   
                data.reduce((map, item) => map.set(item.lgort, item), new Map()).values()                                                                                                                                                                      
              );                                                                                                                                                                                                                                               
              dataModel.setData(dataFiltered);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogLgort: function (oEvent) {                                                                                                                                                                                                               
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("tableDialogLgortDeposit");                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "lgort",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionChangeDialogLgort: function (oEvent) {                                                                                                                                                                                                      
          this.oLgort = oEvent                                                                                                                                                                                                                                 
            .getParameter("listItem")                                                                                                                                                                                                                          
            .getBindingContext("ValueHelpLgort")                                                                                                                                                                                                               
            .getProperty("lgort");                                                                                                                                                                                                                             
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSelectionConfirmDialogLgort: function () {                                                                                                                                                                                                           
          this.byId("searchFieldLgortDeposit").setValue(this.oLgort);                                                                                                                                                                                          
          this.byId("valueHelpDialogLgortDeposit").close();                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // Limpando campos de filtro para busca total dos dados                                                                                                                                                                                                
        onBtnClearPress: function () {                                                                                                                                                                                                                         
          this.getView().byId("searchFieldLgnumDeposit").setValue();                                                                                                                                                                                           
          this.getView().byId("searchFieldWerksDeposit").setValue();                                                                                                                                                                                           
          this.getView().byId("searchFieldLgortDeposit").setValue();                                                                                                                                                                                           
          this.getData();                                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
      }                                                                                                                                                                                                                                                        
    );                                                                                                                                                                                                                                                         
  }                                                                                                                                                                                                                                                            
);                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               