sap.ui.define(                                                                                                                                                                                                                                                 
  [                                                                                                                                                                                                                                                            
    "sap/ui/core/mvc/Controller",                                                                                                                                                                                                                              
    "sap/ui/core/routing/History",                                                                                                                                                                                                                             
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
    "sap/ui/model/json/JSONModel",                                                                                                                                                                                                                             
    "sap/ui/model/Filter",                                                                                                                                                                                                                                     
    "sap/ui/model/FilterOperator",                                                                                                                                                                                                                             
    "sap/ui/core/Fragment",                                                                                                                                                                                                                                    
    "sap/ui/Device",                                                                                                                                                                                                                                           
    "../model/formatter",                                                                                                                                                                                                                                      
  ],                                                                                                                                                                                                                                                           
  function (                                                                                                                                                                                                                                                   
    Controller,                                                                                                                                                                                                                                                
    History,                                                                                                                                                                                                                                                   
    MessageToast,                                                                                                                                                                                                                                              
    JSONModel,                                                                                                                                                                                                                                                 
    Filter,                                                                                                                                                                                                                                                    
    FilterOperator,                                                                                                                                                                                                                                            
    Fragment,                                                                                                                                                                                                                                                  
    Device,                                                                                                                                                                                                                                                    
    formatter                                                                                                                                                                                                                                                  
  ) {                                                                                                                                                                                                                                                          
    "use strict";                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
    return Controller.extend(                                                                                                                                                                                                                                  
      "br.com.lit.zui5.ne.logistics.offline.controller.ReportBalanceStock",                                                                                                                                                                                    
      {                                                                                                                                                                                                                                                        
        formatter: formatter,                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
        onInit: function () {                                                                                                                                                                                                                                  
          const oRouter = this.getOwnerComponent().getRouter();                                                                                                                                                                                                
          oRouter                                                                                                                                                                                                                                              
            .getRoute("RouteReportBalanceStock")                                                                                                                                                                                                               
            .attachPatternMatched(this.onBeforeShow, this);                                                                                                                                                                                                    
          oRouter                                                                                                                                                                                                                                              
            .getRoute("RouteMenu")                                                                                                                                                                                                                             
            .attachPatternMatched(this.onAfterHide, this);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          var oPage = new JSONModel({                                                                                                                                                                                                                          
            page: 0,                                                                                                                                                                                                                                           
            previousPageAvailable: false,                                                                                                                                                                                                                      
            nextPageAvailable: false,                                                                                                                                                                                                                          
          });                                                                                                                                                                                                                                                  
          this.getView().setModel(oPage, "BalanceStockPage");                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          var oBalanceStock = new JSONModel();                                                                                                                                                                                                                 
          this.getView().setModel(oBalanceStock, "BalanceStock");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
          var oStatusSap = new JSONModel();                                                                                                                                                                                                                    
          this.getView().setModel(oStatusSap, "StatusSAP");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          var oFilterLgtyp = new JSONModel();                                                                                                                                                                                                                  
          this.getView().setModel(oFilterLgtyp, "FilterLgtyp");                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
          var oFilterLgpla = new JSONModel();                                                                                                                                                                                                                  
          this.getView().setModel(oFilterLgpla, "FilterLgpla");                                                                                                                                                                                                
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onBeforeShow: function () {                                                                                                                                                                                                                            
          // Voltando para a primeira página ao reabrir a tela                                                                                                                                                                                                 
          let pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          pageModel.setProperty("/page", 0);                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
          this.onClearFilters();                                                                                                                                                                                                                               
          this._startAutoRefresh();                                                                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onAfterHide: function () {                                                                                                                                                                                                                             
          clearInterval(this.intervalHandler);                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _startAutoRefresh: function () {                                                                                                                                                                                                                       
          let self = this;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          this.intervalHandler = setInterval(function () {                                                                                                                                                                                                     
            self._getData();                                                                                                                                                                                                                                   
          }, 500000); // Intervalo de atualização: 5 minutos                                                                                                                                                                                                   
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        _getData: function () {                                                                                                                                                                                                                                
          var dataModel = this.getView().getModel("BalanceStock");                                                                                                                                                                                             
          var pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          let page = pageModel.getProperty("/page");                                                                                                                                                                                                           
          var url =                                                                                                                                                                                                                                            
            `http://localhost:8080/v1/lqua?page=${page}&sort=id&sort=werks&sort=lgort&sort=lgnum&sort=lgtyp&sort=lgpla&sort=matnr&sort=crdate`;                                                                                                                
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroMaterial").getValue() !== "") {                                                                                                                                                                                       
            url += "&matnr=" + this.getView().byId("filtroMaterial").getValue();                                                                                                                                                                               
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroTpDep").getValue() !== "") {                                                                                                                                                                                          
            url += "&lgtyp=" + this.getView().byId("filtroTpDep").getValue();                                                                                                                                                                                  
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroPosition").getValue() !== "") {                                                                                                                                                                                       
            url += "&lgpla=" + this.getView().byId("filtroPosition").getValue();                                                                                                                                                                               
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            success: function (data) {                                                                                                                                                                                                                         
              // Usando forEach para dividir o timestamp e armazenar a data e a hora                                                                                                                                                                           
              data.forEach((item) => {                                                                                                                                                                                                                         
                // item.matnr = matnr.padStart(18, "0");                                                                                                                                                                                                       
                if (item.charg == "0") {                                                                                                                                                                                                                       
                  item.charg = "";                                                                                                                                                                                                                             
                }                                                                                                                                                                                                                                              
                item.matnr = item.matnr.replace(/^0+/, "");                                                                                                                                                                                                    
                if (item.crdate) {                                                                                                                                                                                                                             
                  const [date, time] = item.crdate.split("T"); // Divide entre data e hora                                                                                                                                                                     
                  item.crdate = date.replace(/-/g, "-"); // Formata a data no padrão DD/MM/AAAA                                                                                                                                                                
                  item.hrdate = time.split(".")[0]; // Remove milissegundos da hora                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
              });                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
              dataModel.setData(data);                                                                                                                                                                                                                         
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          this.verifyPreviousPage();                                                                                                                                                                                                                           
          this.verifyNextPage();                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        verifyPreviousPage: function () {                                                                                                                                                                                                                      
          let pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          let page = pageModel.getProperty("/page");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/previousPageAvailable", page > 0 ? true : false);                                                                                                                                                                            
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        verifyNextPage: function () {                                                                                                                                                                                                                          
          let pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          let page = pageModel.getProperty("/page") + 1;                                                                                                                                                                                                       
          var url =                                                                                                                                                                                                                                            
            `http://localhost:8080/v1/lqua?page=${page}&sort=id&sort=werks&sort=lgort&sort=lgnum&sort=lgtyp&sort=lgpla&sort=matnr&sort=crdate`;                                                                                                                
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroMaterial").getValue() !== "") {                                                                                                                                                                                       
            url += "&matnr=" + this.getView().byId("filtroMaterial").getValue();                                                                                                                                                                               
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroTpDep").getValue() !== "") {                                                                                                                                                                                          
            url += "&lgtyp=" + this.getView().byId("filtroTpDep").getValue();                                                                                                                                                                                  
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          if (this.getView().byId("filtroPosition").getValue() !== "") {                                                                                                                                                                                       
            url += "&lgpla=" + this.getView().byId("filtroPosition").getValue();                                                                                                                                                                               
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            success: function (data) {pageModel.setProperty("/nextPageAvailable", data.length > 0 ? true : false);},                                                                                                                                           
            error: function () {pageModel.setProperty("/nextPageAvailable", false);},                                                                                                                                                                          
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
        onPreviousPageBtnPress: function () {                                                                                                                                                                                                                  
          let pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          let page = pageModel.getProperty("/page") - 1;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/page", page);                                                                                                                                                                                                                
          this._getData();                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onNextPageBtnPress: function () {                                                                                                                                                                                                                      
          let pageModel = this.getView().getModel("BalanceStockPage");                                                                                                                                                                                         
          let page = pageModel.getProperty("/page") + 1;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          pageModel.setProperty("/page", page);                                                                                                                                                                                                                
          this._getData();                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearch: function () {                                                                                                                                                                                                                                
          this._getData();                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onClearFilters: function () {                                                                                                                                                                                                                          
          this.getView().byId("filtroMaterial").setValue("");                                                                                                                                                                                                  
          this.getView().byId("filtroTpDep").setValue("");                                                                                                                                                                                                     
          this.getView().byId("filtroPosition").setValue("");                                                                                                                                                                                                  
          this._getData();                                                                                                                                                                                                                                     
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // FILTRANDO MATERIAIS                                                                                                                                                                                                                                 
        onFilterMaterial: function () {                                                                                                                                                                                                                        
          this.byId("dialogMat").open();                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("BalanceStock");                                                                                                                                                                                             
          let url = "http://localhost:8080/v1/lqua";                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              data.forEach((item) => {                                                                                                                                                                                                                         
                item.matnr = item.matnr.replace(/^0+/, "");                                                                                                                                                                                                    
              });                                                                                                                                                                                                                                              
              dataModel.setData(data);                                                                                                                                                                                                                         
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onModFilterMaterial: function () {                                                                                                                                                                                                                     
          // Obter referência à tabela                                                                                                                                                                                                                         
          var oTable = this.getView().byId("materialValueHelpTable");                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
          // Obter o item selecionado                                                                                                                                                                                                                          
          var oSelectedItem = oTable.getSelectedItem();                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
          if (oSelectedItem) {                                                                                                                                                                                                                                 
            // Obter o contexto do modelo associado ao item selecionado                                                                                                                                                                                        
            var oContext = oSelectedItem.getBindingContext("BalanceStock");                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            // Capturar os valores desejados (exemplo: vote_average)                                                                                                                                                                                           
            var sMaterial = oContext.getProperty("matnr");                                                                                                                                                                                                     
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          this.getView("ReportBalanceStock")                                                                                                                                                                                                                   
            .byId("filtroMaterial")                                                                                                                                                                                                                            
            .setValue(sMaterial);                                                                                                                                                                                                                              
          this.byId("dialogMat").close();                                                                                                                                                                                                                      
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogMaterial: function (oEvent) {                                                                                                                                                                                                            
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("materialValueHelpTable");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "matnr",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // FILTRANDO TIPO DE DEPÓSITO                                                                                                                                                                                                                          
        onFilterTpDep: function () {                                                                                                                                                                                                                           
          this.byId("dialogTpDep").open();                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("FilterLgtyp");                                                                                                                                                                                              
          let url = "http://localhost:8080/v1/lgtyp";                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              dataModel.setData(data);                                                                                                                                                                                                                         
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onModFilterTpDep: function () {                                                                                                                                                                                                                        
          // Obter referência à tabela                                                                                                                                                                                                                         
          var oTable = this.getView().byId("tpdepValueHelpTable");                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          // Obter o item selecionado                                                                                                                                                                                                                          
          var oSelectedItem = oTable.getSelectedItem();                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
          if (oSelectedItem) {                                                                                                                                                                                                                                 
            // Obter o contexto do modelo associado ao item selecionado                                                                                                                                                                                        
            var oContext = oSelectedItem.getBindingContext("FilterLgtyp");                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            // Capturar os valores desejados (exemplo: vote_average)                                                                                                                                                                                           
            var sTpDep = oContext.getProperty("lgtyp");                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          this.getView("ReportBalanceStock")                                                                                                                                                                                                                   
            .byId("filtroTpDep")                                                                                                                                                                                                                               
            .setValue(sTpDep);                                                                                                                                                                                                                                 
          this.byId("dialogTpDep").close();                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogTpdep: function (oEvent) {                                                                                                                                                                                                               
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("tpdepValueHelpTable");                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "lgtyp",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        // FILTRANDO POSIÇÃO                                                                                                                                                                                                                                   
        onFilterPosition: function () {                                                                                                                                                                                                                        
          this.byId("dialogPosition").open();                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
          let dataModel = this.getView().getModel("FilterLgpla");                                                                                                                                                                                              
          let url = "http://localhost:8080/v1/lagp";                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
          $.ajax({                                                                                                                                                                                                                                             
            method: "GET",                                                                                                                                                                                                                                     
            url: url,                                                                                                                                                                                                                                          
            contentType: "application/json",                                                                                                                                                                                                                   
            success: function (data) {                                                                                                                                                                                                                         
              dataModel.setData(data);                                                                                                                                                                                                                         
            },                                                                                                                                                                                                                                                 
            error: function (erro) {                                                                                                                                                                                                                           
              console.log(erro);                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                  
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onModFilterPosition: function () {                                                                                                                                                                                                                     
          // Obter referência à tabela                                                                                                                                                                                                                         
          var oTable = this.getView().byId("positionValueHelpTable");                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
          // Obter o item selecionado                                                                                                                                                                                                                          
          var oSelectedItem = oTable.getSelectedItem();                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
          if (oSelectedItem) {                                                                                                                                                                                                                                 
            // Obter o contexto do modelo associado ao item selecionado                                                                                                                                                                                        
            var oContext = oSelectedItem.getBindingContext("FilterLgpla");                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            // Capturar os valores desejados (exemplo: vote_average)                                                                                                                                                                                           
            var sPosition = oContext.getProperty("lgpla");                                                                                                                                                                                                     
          }                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          this.getView("ReportBalanceStock")                                                                                                                                                                                                                   
            .byId("filtroPosition")                                                                                                                                                                                                                            
            .setValue(sPosition);                                                                                                                                                                                                                              
          this.byId("dialogPosition").close();                                                                                                                                                                                                                 
        },                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
        onSearchDialogPosition: function (oEvent) {                                                                                                                                                                                                            
          let oValue = oEvent.getParameter("query");                                                                                                                                                                                                           
          let oTable = this.byId("positionValueHelpTable");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
          oTable.getBinding("items").filter(null);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
          if (oValue) {                                                                                                                                                                                                                                        
            let oFilter = new sap.ui.model.Filter(                                                                                                                                                                                                             
              "lgpla",                                                                                                                                                                                                                                         
              sap.ui.model.FilterOperator.Contains,                                                                                                                                                                                                            
              oValue                                                                                                                                                                                                                                           
            );                                                                                                                                                                                                                                                 
            oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                        
          }                                                                                                                                                                                                                                                    
        },                                                                                                                                                                                                                                                     
      }                                                                                                                                                                                                                                                        
    );                                                                                                                                                                                                                                                         
  }                                                                                                                                                                                                                                                            
);                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               